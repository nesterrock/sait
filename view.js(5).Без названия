"use strict";define("widget-feedBack-view",["jquery","U","goals/handlers","ul-fileinput","icon-set-loader","aDialog","css!/css/require/emailStatusDialog.css"],function(e,t,a,i,r,n){var o={i18nView:function(e){return window.cache.feedBack&&window.cache.feedBack.i18n[e]},name:"feedBack-view",isShowCaptcha:!1,files:[],Captcha:{list:{},get:function(t,a){e.post("/api/captcha",{action:"get"},function(i){if(i[0]||!i[1]||!i[1].url)return void console.log("get captcha error",i[0]);var r=i[1];e("#captcha-"+t.attr("id")).attr("src",r.url),a()})},check:function(e){var t=e.attr("id")},reset:function(e){var t=e.attr("id")}},opened:!1,errors:{},$getWidget:function(e){return e.closest(".ul-widget-feedBack")},initI18n:function(){var e=this;return new Promise(function(t){window.cache.feedBack&&window.cache.feedBack.i18n?t():window.require(["i18n-view"],function(a){e.i18nView=a,t()})})},open:function(e){var t=this,a=document.getElementById(e);a&&this.initI18n().then(function(){t.init(a)})},initCaptcha:function(){var t=this;if(window.grecaptcha){var a=e("#js-captchaPublicKey").data("key");a&&e(".ul-w-feedBack-captchare-fuct").each(function(){var i=e(this).attr("id");t.Captcha.list[i]=window.grecaptcha.render(i,{sitekey:a})})}else setTimeout(function(){t.initCaptcha()},1e3)},send:function(a,i,r){var n=this,o={inputs:[]};e("[ul-model]",a).each(function(){var t=e(this),a=t.attr("ul-model");"inputs"===a.substr(0,6)?o.inputs.push(t.val()):o[a]=t.val()});var s=a.closest(".ul-widget-feedBack").attr("id");if(i=e.extend(!0,i,o),i.inputs){var c=[],l=Object.keys(i.inputs).length-1;l=parseInt(Object.keys(i.inputs)[l]);for(var d=0;l>=d;d++)c.push(i.inputs[d]||"");i.inputs=JSON.stringify(c)}delete i.attachments;var u=new FormData;e.extend(!0,i,{siteUrl:t.params.siteUrl||t.params.site},i);var f=a.attr("action");if(i.isCheck)f=i.url,delete i.url,delete u.isCheck;else{n.files=n.attachmentFile[s].getFileInput();var p=n.files&&Object.keys(n.files).length;if(e(".js-file-input",a).hasClass("required")&&!p)return n.attachmentFile[s].clearInput(),n.attachmentFile[s].clearLabel(),void n.attachmentFile[s].errorMessage(n.i18nView("required field"));p&&e.each(n.files,function(e,t){u.append("attachments",t)})}if(e.each(i,function(e,t){u.append(e,t)}),t.params.isULanding&&!i.isCheck){var m={};window.localStorage&&(m.referrer=localStorage.getItem("firstReferrer")),e.each(a.find("input, textarea"),function(t,a){m[e(a).attr("name")]={value:e(a).val(),hold:e(a).attr("placeholder")}}),e.ajax({url:t.sprintf("/api/stats/lead?site={site}&action=feedback",[t.params.siteUrl||t.params.site]),type:"POST",data:JSON.stringify(m),contentType:"application/json"}).done(function(){}).fail(function(){console.log("lead is false")})}e.ajax({method:"post",url:f,data:u,contentType:!1,processData:!1,success:function(e){n.clearForm(a),e[0]?n.info(a,"server error",1):r(e[1])}})},validateForm:function(t,a,i){var r=this,n=[],o=new FormData;e("[ul-model]",t).each(function(){var t=e(this),a=t.attr("ul-model");"inputs"===a.substr(0,6)?n.push(t.val()):o.append(a,t.val())}),n.length&&o.append("inputs",JSON.stringify(n));var s=function(e,t,a){var i=e.find('[ul-model = "'.concat(t,'"]')).closest(".ul-widget-feedBack-form-group");a[t]&&"attachments"!==t?(r.errors[t]=!0,i.addClass("has-error"),r.showErrorMsg(e,t,a[t])):(r.errors[t]=!1,i.removeClass("has-error"),r.removeErrorMsg(e,t))};e.ajax({method:"post",url:"/api/feedBack/check",data:o,contentType:!1,processData:!1,success:function(e){if(e[0])return void r.info(t,"server error",1);var n={errors:e[1]?e[1].errors:{},etexts:e[1]?e[1].etexts:{}};if(a){var o=a.attr("ul-model");s(t,o,n.etexts)}else Object.keys(n.etexts).forEach(function(e){s(t,e,n.etexts)});if(n.errors&&n.errors.captcha&&!r.isShowCaptcha){var c=r.$getWidget(t);r.Captcha.get(c,function(){r.isShowCaptcha=!0}),r.clearMessage(t)}Object.values(r.errors).includes(!0)?t.find('button[type="submit"]').prop("disabled",!0):t.find('button[type="submit"]').prop("disabled",!1),i&&i(!Object.values(r.errors).includes(!0))}})},init:function(t){var n=this,o=t.id;if(n.opened||(n.opened=!0),n.$el=e("#"+o),!n.$el||0===n.$el.length)return console.log("el not found"),!1;var s=e("form",n.$el);if(r.loadIconSet("fontAwesome",function(){}),window.constructorMode||window.previewMode||window.wizardTemplatePreviewMode)return void s.on("submit.feedBack",function(e){e.preventDefault()});window.localStorage&&document.referrer&&(localStorage.getItem("firstReferrer")||localStorage.setItem("firstReferrer",document.referrer));var c=a.getHandlerFunction(n.$el.data("goalsData")),l=e(".ul-w-feedBack-captcha"),d=e(".js-file-input",s);l.length>0&&l.remove(),n.attachmentFile||(n.attachmentFile={});var u=e.extend({maxFilesCount:20,maxFileSize:25},window.cache.feedback);n.attachmentFile[o]=new i({$el:d,allowedMimeTypes:["text/plain","application/pdf","image/jpeg","image/png","image/gif","image/bmp","application/x-zip-compressed","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/sla","application/vnd.ms-pki.stl","application/x-navistyle","application/dxf","image/vnd.dwg","image/x-dwg","application/acad","image/vnd.dwg","image/x-dwg","image/x-coreldraw","image/cdw","application/x-cdt","application/x-cdw",""],i18nView:this.i18nView,specialFileList:!0,id:o,maxFiles:u.maxFilesCount,maxFileSize:1024*u.maxFileSize*1024,maxSumSize:1024*u.maxFileSize*1024,selectFile:function(){},open:function(){n.errors.attachments=!1,s.find('button[type="submit"]').prop("disabled",!1)},error:function(){n.errors.attachments=!0,s.find('button[type="submit"]').prop("disabled",!0)}}),n.attachmentFile[o].init(),e(".ul-widget-feedBack-form-control[required]",s).on("change",function(){if(/\/uwizard/i.test(window.location.toString()))return!1;var t=e(this);n.validateForm(s,t)}),s.on("submit.feedBack",function(e){e.preventDefault(),n.validateForm(s,null,function(e){e&&n.submitForm(s,c)})});var f=window.location.toString();f.match(/uwizard/)||e.ajax({url:"/api/feedBack/pass",method:"GET",dataType:"json",error:function(){},success:function(e){var t='<input type="text" style="display: none;" value="" ul-model="'+e.name+'" name="'+e.name+'">';s.append(t)}})},infoTimer:null,submitForm:function(t,a){var i=this,r=t.closest(".ul-widget-feedBack").attr("id");return/\/uwizard/i.test(window.location.toString())?!1:(e('button[type="submit"]').attr("disabled","disabled"),i.send(t,{},function(n){return e('button[type="submit"]').removeAttr("disabled"),n?n.etext?i.info(t,n.etext,1):void(n.ok&&(n.afterMail&&i.info(t,n.afterMail,0),i.clearMessage(t),i.attachmentFile[r].clearInput(),i.attachmentFile[r].clearLabel(),a())):void 0}),!1)},info:function(t,a,i){n.open({wide:!1,title:"",data:"<h2>".concat(this.i18nView("widgets.feedBack.name"),'</h2><div class="ul-feedBack-status-dialog">').concat(a,"</div>"),afterOpen:function(){e(document).trigger("openButtonOrderForm")},beforeClose:function(){e(document).trigger("closeButtonOrderForm")}}),i||t[0].reset()},clearForm:function(t){e(".ul-w-feedBack-captcha",t).removeClass("has-error"),e(".ul-widget-feedBack-form-group",t).each(function(){e(this).removeClass("has-error")}),e(".ul-widget-feedBack-responce",t).hide().text("")},clearMessage:function(t){e('[ul-model="message"]',t).val("")},destroy:function(){e("form").off("submit.feedBack",this.submitForm)},showErrorMsg:function(t,a,i){var r=t.find('[ul-model = "'+a+'"]').closest(".ul-widget-feedBack-form-group"),n=r.find(".error-msg");n.length||(n=e("<div>",{"class":"error-msg"}),n.appendTo(r)),n.html(i)},removeErrorMsg:function(e,t){var a=e.find('[ul-model = "'+t+'"]').closest(".ul-widget-feedBack-form-group"),i=a.find(".error-msg");i.length&&i.remove()},parseErrors:function(t,a){if(t){var i="",r=a?a:Object.keys(t);return r.forEach(function(a){t[a]&&("captcha"===a?e(".ul-w-feedBack-captcha").addClass("has-error"):e('[ul-model = "'+a+'"]').closest(".ul-widget-feedBack-form-group").addClass("has-error"),i+=t[a]+"\n")}),i||!1}return!1}};return o});
//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map

//# sourceMappingURL=view.js.map
